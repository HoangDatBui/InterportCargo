@page "{id:int}"
@model InterportCargo.Pages.Quotations.PrepareModel
@{
    ViewData["Title"] = "Prepare Quotation";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>Prepare Quotation
                    </h3>
                </div>
                <div class="card-body p-4">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <form method="post">
                        <!-- Customer Information (Read-Only) -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-user me-2"></i>Customer Information
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Customer Name:</label>
                                        <input type="text" class="form-control" value="@Model.CustomerName" readonly />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Email:</label>
                                        <input type="text" class="form-control" value="@Model.CustomerEmail" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quotation Details -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-file-invoice me-2"></i>Quotation Details
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="QuotationNumber" class="form-label fw-bold">Quotation Number:</label>
                                        <input asp-for="QuotationNumber" class="form-control" readonly />
                                        <span asp-validation-for="QuotationNumber" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="DateIssued" class="form-label fw-bold">Date Issued:</label>
                                        <input asp-for="DateIssued" type="text" class="form-control" readonly />
                                        <span asp-validation-for="DateIssued" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Container Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-box me-2"></i>Container Information
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="ContainerType" class="form-label fw-bold">Container Type:</label>
                                        <select asp-for="ContainerType" class="form-select" required>
                                            <option value="">-- Select Container Type --</option>
                                            @foreach (var type in Model.AvailableContainerTypes)
                                            {
                                                <option value="@type">@type</option>
                                            }
                                        </select>
                                        <span asp-validation-for="ContainerType" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Estimated Container Count:</label>
                                        <input type="text" class="form-control" value="@Model.EstimatedContainerCount" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scope Description -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Scope Description
                                </h5>
                                <label asp-for="Scope" class="form-label fw-bold">Description of the Job:</label>
                                <textarea asp-for="Scope" class="form-control" rows="5" required placeholder="Enter a detailed description of the job..."></textarea>
                                <span asp-validation-for="Scope" class="text-danger"></span>
                                <small class="form-text text-muted">
                                    Suggested: @Model.SuggestedScope
                                </small>
                            </div>
                        </div>

                        <!-- Charges -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-dollar-sign me-2"></i>Charges Summary
                                </h5>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span class="fw-semibold" style="white-space: nowrap;">Subtotal:</span>
                                                <span id="subtotal" class="text-end text-nowrap">$0.00</span>
                                            </li>
                                            <li id="discountRow" class="list-group-item d-flex justify-content-between align-items-center text-success" style="display: none;">
                                                <span class="fw-semibold" style="white-space: nowrap;">Discount (@Model.DiscountPercentage%):</span>
                                                <span class="fw-semibold text-nowrap">-<span id="discountAmount">$0.00</span></span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span class="fw-semibold" style="white-space: nowrap;">GST (10%):</span>
                                                <span id="gst" class="text-end text-nowrap">$0.00</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center border-top pt-3">
                                                <span class="fw-bold" style="white-space: nowrap;">Total Amount:</span>
                                                <span class="fw-bold text-primary text-nowrap" id="totalAmount">$0.00</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden Inputs -->
                        <input type="hidden" asp-for="QuotationRequestId" />
                        <input type="hidden" id="calculatedSubtotal" name="CalculatedSubtotal" value="0" />
                        <input type="hidden" id="calculatedDiscountPercentage" name="CalculatedDiscountPercentage" value="@Model.DiscountPercentage" />
                        <input type="hidden" id="calculatedDiscountAmount" name="CalculatedDiscountAmount" value="0" />
                        <input type="hidden" id="calculatedGST" name="CalculatedGST" value="0" />
                        <input type="hidden" id="calculatedTotalAmount" name="CalculatedTotalAmount" value="0" />

                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-12 d-flex justify-content-between">
                                <a href="/Quotations/Details/@Model.QuotationRequestId" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>Save Quotation
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const discountPercentage = @Model.DiscountPercentage;
        const estimatedContainers = @Model.EstimatedContainerCount;
        const quotationRequestId = @Model.QuotationRequestId;

        // Calculate charges when container type is selected
        document.getElementById('ContainerType').addEventListener('change', function() {
            calculateCharges();
        });

        function calculateCharges() {
            const containerType = document.getElementById('ContainerType').value;
            
            if (!containerType) {
                // Reset to zero if no container type selected
                updateCharges(0, 0, 0, 0);
                return;
            }

            // Fetch rates from backend
            fetch('/Quotations/Prepare/' + quotationRequestId + '?handler=GetRates&containerType=' + encodeURIComponent(containerType))
                .then(response => response.json())
                .then(data => {
                    let subtotal = 0;
                    
                    // Calculate subtotal based on rates
                    if (data.rates) {
                        data.rates.forEach(rate => {
                            const rateValue = containerType === '20 Feet Container' ? rate.rate20Feet : rate.rate40Feet;
                            // Each rate applies to the number of containers
                            subtotal += rateValue * estimatedContainers;
                        });
                    }

                    // Calculate discount
                    const discountAmount = subtotal * (discountPercentage / 100);
                    const amountAfterDiscount = subtotal - discountAmount;
                    const gst = amountAfterDiscount * 0.10;
                    const totalAmount = amountAfterDiscount + gst;

                    // Update UI
                    updateCharges(subtotal, discountAmount, gst, totalAmount);
                })
                .catch(error => {
                    console.error('Error calculating charges:', error);
                    alert('Error calculating charges. Please try again.');
                });
        }

        function updateCharges(subtotal, discountAmount, gst, totalAmount) {
            // Update display
            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('discountAmount').textContent = '$' + discountAmount.toFixed(2);
            document.getElementById('gst').textContent = '$' + gst.toFixed(2);
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toFixed(2);

            // Show/hide discount row
            if (discountPercentage > 0) {
                document.getElementById('discountRow').style.display = 'block';
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }

            // Update hidden fields
            document.getElementById('calculatedSubtotal').value = subtotal.toFixed(2);
            document.getElementById('calculatedDiscountPercentage').value = discountPercentage.toFixed(2);
            document.getElementById('calculatedDiscountAmount').value = discountAmount.toFixed(2);
            document.getElementById('calculatedGST').value = gst.toFixed(2);
            document.getElementById('calculatedTotalAmount').value = totalAmount.toFixed(2);
        }

        // Calculate on page load if container type is already selected
        window.addEventListener('load', function() {
            if (document.getElementById('ContainerType').value) {
                calculateCharges();
            }
        });
    </script>
}
